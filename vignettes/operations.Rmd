---
title: "Operations"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
vignette: >
  %\VignetteIndexEntry{Operations}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
options(try.outFile = stdout()) # show error messages in try statements
```

```{r, message=FALSE}
library(tidyverse) # load tidyverse tools
library(mediatools) # load the library
```

## Units & Metric Scaling

All chemical quantities in this package keep track of the units they represent with a base unit as detailed in the [quantities vignette](quantities.html) and a metric prefix. By default, the metric prefix is adjusted automatically to keep numeric values in a range close to 1. However, scaling to a specific prefix is easily achieved.

```{r}
# automatic scaling
qty(5000, "g") # automatically scaled to kg
qty(5000, "g", scale_to_best_metric = FALSE) # stays g
# specific scaling
qty(100, "mg") %>% base_metric() # scale to the base unit (here g)
qty(100, "mM") %>% base_metric() # scale to the base unit (here M)
qty(100, "mg") %>% scale_metric("k")
```

The units of a quantity can be retrieved easily with the `get_qty_units()` function

```{r}
qty(5000, "g") %>% get_qty_units()
```

## Arithmetic

Several common arithmetic operations are implemented for easy interconversion between quantities. All arithmetic operations also automatically keep track of the units and metric prefixes for correct calculations.

### Addition and Subtraction

Quantities of the same type (e.g. masses, volumes, etc.) can be added or subtracted with proper interpration of the metric prefixes. The resulting quantity will be scaled to the best metric prefix as described above. Attempts to add or subtract non-matching quantities (e.g. mass + volume) or a quantity and a number without units will fail with an error to avoid unexpect behaviour and ambiguous calculations. 

```{r}
qty(0.003, "g") - qty(2, "mg") + qty(5, "Âµg") # 1.005 mg
try(qty(1, "g") + qty(1, "L")) # not allowed
try(qty(1, "g") + 1) # not allowed
```

### Multiplication / Division

Quantities can be multipled/divided by a number. The resulting quantity will be scaled to the best metric prefix. This is most commonly used with multiplication/division by 1000.

```{r}
qty(1, "mg") * 1000 # convert mg into g
qty(1, "mg") / 1e6 # convert mg into ng
```

Quantities can also be divided by another quantity of the same type (e.g. a mass by another mass) effectively canceling out the units resulting in a regular number (with the metric prefixes properly taken into consideration).

```{r}
# how many mg in a kg?
qty(1, "mg") / qty(1, "kg")
```

Additional multiplications and divisions are possible for specific combinations of quantities as detailed below. These formulas are each implemented for all three possible arrangements.

#### Molarity = Amount / Volume

```{r}
qty(5, "nmol") / qty(50, "mL") # calculation molarity
qty(5, "nmol") / qty(100, "nM") # calculate volume
qty(100, "nM") * qty(50, "mL") # calculate amount
```

#### Density = Mass / Volume

```{r}
qty(5, "ng") / qty(50, "mL") # calculate density
qty(5, "ng") / qty(100, "ng/L") # calculate volume
qty(100, "ng/L") * qty(50, "mL") # calculate mass
```

#### Amount = Mass / Molecular Mass

```{r}
qty(10, "g") / qty (50, "g/mol") # calculate amount
qty(10, "g") / qty(200, "mmol") # calculate molecular mass
qty(200, "mmol") * qty (50, "g/mol") # calculate mass
```

#### Solubility = Molarity / Pressure

```{r}
qty(10, "mM") / qty(200, "mbar") # calculate solubility
qty(10, "mM") / qty(50, "mM/bar") # calculate pressure
qty(50, "mM/bar") * qty (200, "mbar") # calculate molarity
```


### Comparisons

Quantities can be compared with all common logic operators (`>`, `>=`, `<`, `<=`, `==`, `!=`) taking the metric scaling properly into consideration. Attempts to compare non-matching quantities (e.g. mass & volume) or a quantity and a number without units will fail with an error to avoid unexpect behaviour and ambiguous comparisons.

```{r}
qty(5, "mg") < qty(1, "g")
qty(5, "mg") > qty(10, "ng")
qty(5, "mg") == qty(0.005, "g")
qty(5, "mg") != qty(5, "g")
try(qty(1, "mg") > qty(1, "L")) # not allowed (different quantities)
try(qty(1, "mg") == 1) # not allowed (ambiguous comparison)
```

It is important to note that due to machine errors, the `==` is best avoided in favor of more reliable comparisions such as test that check whether the difference between quantities is smaller than a tiny quantity:

```{r}
(x <- qty(1, "mg"))
(y <- x / 3)
(x2 <- y * 3)
x == x2 # should be identical but is not because of machine precision
abs(x - x2) < qty(1, "fg") # absolute difference smaller than 1 femtogram
```


## Data Frames

Quantities are fully supported in dplyr type data frames and the units of a quantity are displayed underneath the column headers, e.g. `<mg>` to indicate a quantity column that has the units of `mg` (and thus is a mass). 

```{r}
data_frame(
  weight = qty(1:5, "mg"),
  volume = qty(20, "mL")
)
```

This also means that all common arithmetic operations are allowed within data frames.

```{r}
data_frame(
  weight = qty(1:5, "mg"),
  vol = qty(20, "mL"),
  mw = qty(500, "g/mol"),
  amount = weight / mw,
  conc = amount / vol,
  new_vol = 50 * qty(20, "mL"),
  new_weight = conc * new_vol * mw,
  `correct?` = abs(50 * weight - new_weight) < qty(1, "fg")
)
```

## Concatenation

Quantities can be concatenated using the regular `c()` function (or the more explicit `c_qty()`) as long as they are the same type of quantity (e.g. all masses). Concatenation make sure that the metric prefix is taken into consideration and scales the new vector to the best metric of the median. 

```{r}
c(
  qty(1, "g"), 
  qty(1:3, "mg"),
  qty(2, "g")
)
```

## Missing data

Missing data (`NA`), empty vector (`numeric(0)`) and  infinity placeholders (`Inf`, `-Inf`) are supported in all quantities and work the same as in any other R vectors.

```{r}
qty(NA, "mg")
qty(Inf, "mg")
qty(numeric(0), "mg")
qty(c(10, NA, -Inf, Inf, numeric(0)), "mg")
```

## Miscellaneous

To check whether something is a quantity, use the `is_qty()` function.

```{r}
qty(1, "mg") %>% is_qty() # is a quantity
1 %>% is_qty() # not a quantity
```

